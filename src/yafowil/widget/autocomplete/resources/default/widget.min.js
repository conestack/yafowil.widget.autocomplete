var yafowil_autocomplete=function(e,t){"use strict";class s{constructor(e,s,i){if(this.widget=e,t.isPlainObject(s))this.key=Object.keys(s)[0],this.value=Object.values(s)[0];else{if("string"!=typeof s)throw"yafowil.widget.autocomplete: Invalid Suggestion type. Suggestionmust be string or {key: value} object.";this.key=null,this.value=s}this.val=i,this.compile(),this.selected=!1,this.select=this.select.bind(this),this.elem.off("mousedown",this.select).on("mousedown",this.select)}compile(){let e=this.value.toUpperCase().indexOf(this.val.toUpperCase());this.elem=t("<div />").addClass("autocomplete-suggestion").appendTo(this.widget.dd_elem),t("<span />").text(this.value.substring(0,e)).appendTo(this.elem),t("<strong />").text(this.value.substring(e,e+this.val.length)).appendTo(this.elem),t("<span />").text(this.value.substring(e+this.val.length)).appendTo(this.elem)}get selected(){return this._selected}set selected(e){e?(this._selected=!0,this.elem.addClass("selected")):(this._selected=!1,this.elem.removeClass("selected"))}select(){this.selected=!0,this.widget.select_suggestion(this.key,this.value)}}class i{static initialize(e){t("div.yafowil-widget-autocomplete",e).each((function(){let e=t(this);void 0!==window.yafowil_array&&window.yafowil_array.inside_template(e)||new i(e)}))}constructor(e){e.data("yafowil-autocomplete",this),this.elem=e,this.result_key_elem=t("input.autocomplete-result-key",e),this.Suggestion=s,this.compile(),this.suggestions=[],this.current_focus=0;let i=this.parse_options();this.sourcetype=i.type,this.delay=i.delay,this.min_length=i.minLength,this.parse_source(),this.on_input=this.on_input.bind(this),this.hide_dropdown=this.hide_dropdown.bind(this),this.on_keydown=this.on_keydown.bind(this),this.input_elem.on("focusout",this.hide_dropdown).on("focus input",this.on_input).on("keydown",this.on_keydown),this.autocomplete=this.autocomplete.bind(this)}compile(){this.input_elem=t("input.autocomplete",this.elem).attr("spellcheck",!1).attr("autocomplete","off"),this.dd_elem=t("<div />").addClass("autocomplete-dropdown").appendTo("body")}unload(){clearTimeout(this.timeout),this.input_elem.off("focusout",this.hide_dropdown).off("focus input",this.on_input).off("keydown",this.on_keydown)}parse_options(){let e=t(".autocomplete-params",this.elem).text().split("|"),s=[];for(let t=0;t<e.length;t++){let i=e[t].split(","),o=i[1].replace(/^\s+|\s+$/g,"");isNaN(o)?"True"===o?o=!0:"False"===o&&(o=!1):o=parseInt(o),s[i[0].replace(/^\s+|\s+$/g,"")]=o}return s}parse_source(){let e=t(".autocomplete-source",this.elem).text();if(0===e.indexOf("javascript:")){let t=e.substring(11,e.length).split("."),s=window;for(let i of t)if(s=s[i],void 0===s)throw new Error("Cannot locate source function: "+e);this.source=function(e,t){s(e,t)}}else if("local"===this.sourcetype){if(""===e)throw new Error("Local source is empty");this.source=function(t,s){let i=e.split("|"),o=t.term,l=[];for(let e of i)e.toUpperCase().indexOf(o.toUpperCase())>-1&&l.push(e);s(l)}}else"remote"===this.sourcetype&&(this.source=function(s,i){t.ajax({url:e,data:{term:s.term},dataType:"json",success:function(e){i(e)},error:function(){throw i([]),new Error("Cannot locate JSON at: "+e)}})})}on_input(e){clearTimeout(this.timeout),this.dd_elem.empty().hide(),this.suggestions=[],this.current_focus=-1,this.input_elem.val().length>=this.min_length&&(this.timeout=setTimeout(this.autocomplete,this.delay))}autocomplete(){let e=this.input_elem.val();this.source({term:e},(s=>{if(!Array.isArray(s))throw"yafowil.widget.autocomplete: invalid datatype, data must be array of strings or {key: value} objects";if(!s.length)return;for(let t of s)this.suggestions.push(new this.Suggestion(this,t,e));let i,o=t(document).scrollTop(),l=this.elem.offset().top,n=this.elem.offset().left,r=this.elem.outerHeight(),h=this.dd_elem.outerHeight();i=l+r+h>=o+t(window).outerHeight()?l-h:l+r,this.dd_elem.css({top:`${i}px`,left:`${n}px`}),this.dd_elem.show()}))}on_keydown(e){let t=this.dd_elem.scrollTop();switch(e.key){case"ArrowDown":this.current_focus++,this.add_active(!0);break;case"ArrowUp":this.current_focus--,this.add_active(!1);break;case"Enter":if(e.preventDefault(),this.current_focus>-1){let e=this.suggestions[this.current_focus];e.select(),this.input_elem.val(e.value),this.hide_dropdown(),this.input_elem.trigger("blur")}break;case"Escape":this.hide_dropdown(),this.input_elem.trigger("blur");break;case"Tab":if(this.hide_dropdown(),this.current_focus>-1){let e=this.suggestions[this.current_focus];this.input_elem.val(e.value),this.hide_dropdown(),this.input_elem.trigger("blur")}break;case"PageDown":if(e.preventDefault(),this.dd_elem.scrollTop(t+this.dd_elem.height()),this.current_focus>-1){let e=0;for(let t in this.suggestions){this.suggestions[t].elem.offset().top<this.dd_elem.offset().top&&e++}this.current_focus=e;let t=this.suggestions[e];this.unselect_all(),t.selected=!0}break;case"PageUp":if(e.preventDefault(),this.dd_elem.scrollTop(t-this.dd_elem.height()),this.current_focus>-1){let e=0;for(let t in this.suggestions){this.suggestions[t].elem.offset().top<this.dd_elem.offset().top&&e++}this.current_focus=e;let t=this.suggestions[e];this.unselect_all(),t.selected=!0}break;default:this.result_key_elem.val("")}}select_suggestion(e,t){this.hide_dropdown(),this.input_elem.val(t),e&&this.result_key_elem.val(e)}unselect_all(){this.result_key_elem.val("");for(let e of this.suggestions)e.selected=!1}add_active(e){if(0===this.suggestions.length)return;this.unselect_all(),this.current_focus>=this.suggestions.length?this.current_focus=0:this.current_focus<0&&(this.current_focus=this.suggestions.length-1);let t=this.suggestions[this.current_focus];t.selected=!0;let s=this.dd_elem.scrollTop(),i=t.elem.offset().top,o=t.elem.outerHeight(),l=this.dd_elem.offset().top,n=this.dd_elem.outerHeight();e?0===this.current_focus?this.dd_elem.scrollTop(0):i+o>l+n&&this.dd_elem.scrollTop(s+o):this.current_focus>=this.suggestions.length-1?this.dd_elem.scrollTop(o*this.suggestions.length):i<l&&this.dd_elem.scrollTop(s-o)}hide_dropdown(){this.dd_elem.hide()}}function o(e,t){i.initialize(t)}function l(){void 0!==window.yafowil_array?window.yafowil_array.on_array_event("on_add",o):void 0!==yafowil.array&&t.extend(yafowil.array.hooks.add,{autocomplete_binder:i.initialize})}return t((function(){void 0!==window.ts?ts.ajax.register(i.initialize,!0):void 0!==window.bdajax?bdajax.register(i.initialize,!0):i.initialize(),l()})),e.AutocompleteSuggestion=s,e.AutocompleteWidget=i,e.register_array_subscribers=l,Object.defineProperty(e,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.autocomplete=e,e}({},jQuery);
