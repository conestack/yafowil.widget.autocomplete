var yafowil_autocomplete=function(t,e){"use strict";class s{constructor(t,s,i){if(this.widget=t,e.isPlainObject(s))this.id=s.id,this.value=s.title;else{if("string"!=typeof s)throw"yafowil.widget.autocomplete: Invalid Suggestion type. Suggestionmust be string or {key: value} object.";this.id=null,this.value=s}this.val=i,this.compile(),this.selected=!1,this.select=this.select.bind(this),this.elem.off("mousedown",this.select).on("mousedown",this.select)}compile(){let t=this.value.toUpperCase().indexOf(this.val.toUpperCase());this.elem=e("<div />").addClass("autocomplete-suggestion").appendTo(this.widget.dd_elem),e("<span />").text(this.value.substring(0,t)).appendTo(this.elem),e("<strong />").text(this.value.substring(t,t+this.val.length)).appendTo(this.elem),e("<span />").text(this.value.substring(t+this.val.length)).appendTo(this.elem)}get selected(){return this._selected}set selected(t){t?(this._selected=!0,this.elem.addClass("selected")):(this._selected=!1,this.elem.removeClass("selected"))}select(){this.selected=!0,this.widget.select_suggestion(this.id,this.value)}}class i{static initialize(t){e("div.yafowil-widget-autocomplete",t).each((function(){let t=e(this);void 0!==window.yafowil_array&&window.yafowil_array.inside_template(t)||new i(t)}))}constructor(t){t.data("yafowil-autocomplete",this),this.elem=t,this.result_input=e("input.autocomplete-result",t),this.input_elem=e("input.autocomplete",t),this.delay=this.input_elem.data("delay"),this.sourcetype=this.input_elem.data("type"),this.min_length=this.input_elem.data("minLength"),this.Suggestion=s,this.compile(),this.suggestions=[],this.current_focus=0,this.parse_source(),this.on_input=this.on_input.bind(this),this.hide_dropdown=this.hide_dropdown.bind(this),this.on_keydown=this.on_keydown.bind(this),this.input_elem.on("focusout",this.hide_dropdown).on("focus input",this.on_input).on("keydown",this.on_keydown),this.autocomplete=this.autocomplete.bind(this)}compile(){this.input_elem.attr("spellcheck",!1).attr("autocomplete","off"),this.dd_elem=e("<div />").addClass("autocomplete-dropdown").appendTo("body")}unload(){clearTimeout(this.timeout),this.input_elem.off("focusout",this.hide_dropdown).off("focus input",this.on_input).off("keydown",this.on_keydown)}parse_source(){const t=this.input_elem.data("source");if(0===t.indexOf("javascript:")){let e=t.substring(11,t.length).split("."),s=window;for(let i of e)if(s=s[i],void 0===s)throw new Error("Cannot locate source function: "+t);this.source=function(t,e){s(t,e)}}else if("local"===this.sourcetype){if(""===t)throw new Error("Local source is empty");this.source=function(e,s){let i=t.split("|"),o=e.term,l=[];for(let t of i)t.toUpperCase().indexOf(o.toUpperCase())>-1&&l.push(t);s(l)}}else"remote"===this.sourcetype&&(this.source=function(s,i){e.ajax({url:t,data:{term:s.term},dataType:"json",success:function(t){i(t)},error:function(){throw i([]),new Error("Cannot locate JSON at: "+t)}})})}on_input(t){clearTimeout(this.timeout),this.dd_elem.empty().hide(),this.suggestions=[],this.current_focus=-1,this.input_elem.val().length>=this.min_length&&(this.timeout=setTimeout(this.autocomplete,this.delay))}autocomplete(){let t=this.input_elem.val();this.source({term:t},(s=>{if(!Array.isArray(s))throw"yafowil.widget.autocomplete: invalid datatype, data must be array of strings or objects";if(!s.length)return;for(let e of s)this.suggestions.push(new this.Suggestion(this,e,t));let i,o=e(document).scrollTop(),l=this.elem.offset().top,n=this.elem.offset().left,h=this.elem.outerHeight(),u=this.dd_elem.outerHeight();i=l+h+u>=o+e(window).outerHeight()?l-u:l+h,this.dd_elem.css({top:`${i}px`,left:`${n}px`}),this.dd_elem.show()}))}on_keydown(t){let e=this.dd_elem.scrollTop();switch(t.key){case"ArrowDown":this.current_focus++,this.add_active(!0);break;case"ArrowUp":this.current_focus--,this.add_active(!1);break;case"Enter":if(t.preventDefault(),this.current_focus>-1){let t=this.suggestions[this.current_focus];t.select(),this.select_suggestion(t.id,t.value)}break;case"Escape":this.hide_dropdown(),this.input_elem.trigger("blur");break;case"Tab":if(this.hide_dropdown(),this.current_focus>-1){let t=this.suggestions[this.current_focus];t.select(),this.select_suggestion(t.id,t.value)}break;case"PageDown":if(t.preventDefault(),this.dd_elem.scrollTop(e+this.dd_elem.height()),this.current_focus>-1){let t=0;for(let e in this.suggestions){this.suggestions[e].elem.offset().top<this.dd_elem.offset().top&&t++}this.current_focus=t;let e=this.suggestions[t];this.unselect_all(),e.selected=!0}break;case"PageUp":if(t.preventDefault(),this.dd_elem.scrollTop(e-this.dd_elem.height()),this.current_focus>-1){let t=0;for(let e in this.suggestions){this.suggestions[e].elem.offset().top<this.dd_elem.offset().top&&t++}this.current_focus=t;let e=this.suggestions[t];this.unselect_all(),e.selected=!0}break;default:this.result_input.val("")}}select_suggestion(t,e){this.input_elem.val(e).trigger("blur"),this.hide_dropdown(),t?this.result_input.val(t):this.result_input.val(e)}unselect_all(){this.result_input.val("");for(let t of this.suggestions)t.selected=!1}add_active(t){if(0===this.suggestions.length)return;this.unselect_all(),this.current_focus>=this.suggestions.length?this.current_focus=0:this.current_focus<0&&(this.current_focus=this.suggestions.length-1);let e=this.suggestions[this.current_focus];e.selected=!0;let s=this.dd_elem.scrollTop(),i=e.elem.offset().top,o=e.elem.outerHeight(),l=this.dd_elem.offset().top,n=this.dd_elem.outerHeight();t?0===this.current_focus?this.dd_elem.scrollTop(0):i+o>l+n&&this.dd_elem.scrollTop(s+o):this.current_focus>=this.suggestions.length-1?this.dd_elem.scrollTop(o*this.suggestions.length):i<l&&this.dd_elem.scrollTop(s-o)}hide_dropdown(){this.dd_elem.hide()}}function o(t,e){i.initialize(e)}function l(){void 0!==window.yafowil_array?window.yafowil_array.on_array_event("on_add",o):void 0!==yafowil.array&&e.extend(yafowil.array.hooks.add,{autocomplete_binder:i.initialize})}return e((function(){void 0!==window.ts?ts.ajax.register(i.initialize,!0):void 0!==window.bdajax?bdajax.register(i.initialize,!0):i.initialize(),l()})),t.AutocompleteSuggestion=s,t.AutocompleteWidget=i,t.register_array_subscribers=l,Object.defineProperty(t,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.autocomplete=t,t}({},jQuery);
